name: Release to Docker Hub

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

env:
  USER: ${{ secrets.DOCKERHUB_USERNAME }}
  REPO: ${{ secrets.DOCKERHUB_REPONAME }}

jobs:
  push-to-hub:
    runs-on: ubuntu-latest
    steps:

      - name: Set up dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: jq curl grep tar xz-utils
          version: 1.0

      - name: Checkout
        uses: actions/checkout@v6

    
      ##########################
      # 1. Fetch latest upstream tag
      ##########################
      - name: Fetch latest release tag
        uses: pozetroninc/github-action-get-latest-release@v0.8.0
        id: latest-tag
        with:
          repository: pi-hole/docker-pi-hole
      
      
      - name: Set APP_VERSION      
        run: |
          echo "APP_VERSION=${{ steps.latest-tag.outputs.release }}" >> $GITHUB_ENV
          echo "Latest upstream tag: ${{ env.APP_VERSION }}"
      
       ##########################
      # 2. Determine if NEED_BUILD
      ##########################
      - name: Determine if new upstream
        id: check-upstream
        run: |
          if [ "${GITHUB_EVENT_NAME}" == "push" ]; then
            # Merge PR → new upstream
            echo "NEED_BUILD=true" >> $GITHUB_ENV
          else
            # Daily / manual → check Docker Hub
            APP_VERSION="${{ env.APP_VERSION }}"
            EXISTING=$(curl -s "https://hub.docker.com/v2/repositories/${USER}/${REPO}/tags/?page_size=100" \
              | jq -r ".results[].name | select(startswith(\"${APP_VERSION}-z\"))" | head -n1)
            if [ -z "$EXISTING" ]; then
              echo "NEED_BUILD=true" >> $GITHUB_ENV
            else
              echo "NEED_BUILD=false" >> $GITHUB_ENV
            fi
          fi
   
      ##########################
      # 5. Calculate FINAL_TAG
      ##########################
      - name: Calculate FINAL_TAG
        run: |
          APP_VERSION="${{ env.APP_VERSION }}"
          # echo "APP_VERSION=$APP_VERSION"

          # Fetch Docker Hub tags
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/${USER}/${REPO}/tags/?page_size=100" | jq -r '.results[].name')
          # echo "All TAGS: $TAGS"

          # Filter tags that match APP_VERSION with -zNN
          MATCHING_TAGS=$(echo "$TAGS" | grep -E "^${APP_VERSION}-z[0-9]+$" || true)
          echo "Matching tags: $MATCHING_TAGS"

          # Get highest build number
          if [ -z "$MATCHING_TAGS" ]; then
            BUILD_NUM=0
          else
            LAST=$(echo "$MATCHING_TAGS" | sed -E "s/^${APP_VERSION}-z([0-9]+)/\1/" | sort -n | tail -1)
            BUILD_NUM=$((LAST + 1))
          fi

          # Format as two digits
          BUILD_NUM=$(printf "%02d" $BUILD_NUM)
          FINAL_TAG="${APP_VERSION}-z${BUILD_NUM}"
          echo "FINAL_TAG=$FINAL_TAG" >> $GITHUB_ENV
          echo "FINAL_TAG=$FINAL_TAG"

      ##########################
      # 6. Setup Docker Buildx + login
      ##########################
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      ##########################
      # 7. Build multi-arch if new upstream or push main
      ##########################
      - name: Build & push multi-arch
        id: docker_build_push
        if: env.NEED_BUILD == 'true' || github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: |
            linux/amd64
            linux/arm64
            linux/arm/v8
            linux/arm/v7
          push: true
          provenance: false
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:${{ env.FINAL_TAG }}
      
      - name: Slack Notification
        if: steps.docker_build_push.outputs.digest != '' 
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "Docker Image Pushed"
          SLACK_MESSAGE: "A new version of pihole-dot-doh has been pushed to Docker Hub."
          SLACK_COLOR: good
 